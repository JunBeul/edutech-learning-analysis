# Technical Issues and Resolutions 정리

---

## 전체 요약

리스크 예측 파이프라인 개발 과정에서 반복적으로 발생한 문제는 단순 버그가 아니라 데이터 시점 차이, 결측 표현 방식, feature 계약 불일치, 해석 로직 품질, 검증 자동화 부족이 결합된 구조적 이슈였습니다.  
이 문서는 개별 증상을 나열하는 대신 공통 원인과 대응 원칙을 정리하는 데 목적이 있습니다.

핵심 대응 원칙은 다음 세 가지입니다.  
첫째, 결측을 값으로 숨기지 않고 정보로 유지한다.  
둘째, 학습/추론 feature 스키마를 명시적으로 고정한다.  
셋째, 전처리 변경은 스모크 테스트로 즉시 회귀를 검출한다.

---

## 문제 정의

1. 중간 시점 데이터의 `NaN` 입력으로 모델 학습/추론이 실패했습니다.
2. 결측을 일괄 `0`으로 대체하면서 실제 `0`과 결측이 구분되지 않아 모델 해석이 왜곡되었습니다.
3. 시점별(중간/기말) 컬럼 유무 차이로 스키마 검증 단계에서 오류가 발생했습니다.
4. 학습 시점 feature 집합과 추론 시점 feature 집합 불일치로 입력 차원 오류가 발생했습니다.
5. 결측 보정 이후 위험 사유 생성 로직이 실제 결측 맥락을 반영하지 못했습니다.
6. 참여도 지표가 고정 임계값 중심이라 학급/학교별 상대 맥락을 충분히 반영하지 못했습니다.
7. 전처리 수정 후 기존 동작이 유지되는지 빠르게 검증할 자동화 장치가 부족했습니다.

---

## 원인 파악

1. 데이터 구조의 시간적 비대칭.

- 중간 시점에는 존재하지 않는 컬럼이 자연스럽게 발생하지만, 파이프라인이 이를 예외가 아닌 정상 케이스로 처리하지 못했습니다.

2. 결측 표현 전략 부재.

- 결측 대체는 수행했지만 "결측이었다"는 메타정보를 유지하지 않아, 모델이 결측과 실제 저성취를 동일하게 해석했습니다.

3. feature contract 관리 부족.

- 코드 내 `FEATURE_COLS` 정의와 실제 모델 객체가 기대하는 feature 순서/집합이 분리되어 drift가 발생했습니다.

4. 분석 로직의 기준 데이터 불일치.

- 위험 사유 생성이 정제 후 데이터에만 의존해, 원본 데이터의 결측 맥락을 놓쳤습니다.

5. 정적 임계값 의존.

- 참여도 평가를 고정 컷으로 적용해, 분포가 달라지는 환경에서 민감도/특이도 균형이 깨졌습니다.

6. 검증 자동화 부족.

- 수동 점검 중심이라 전처리 변경이 다른 단계에 미치는 회귀 영향을 빠르게 파악하기 어려웠습니다.

---

## 해결 방안

1. 결측 보정 fallback을 명시화했습니다.

- all-NaN 컬럼은 안전값 `0`으로 대체.
- 일반 결측은 median/mean 대체.
- 결측 대체 정책을 코드 레벨에서 일관 규칙으로 통합.

2. 결측 플래그를 feature로 추가했습니다.

- `final_score_missing`, `performance_score_missing`, `midterm_score_missing` 등을 도입.
- 값 자체와 결측 여부를 분리해 모델이 두 정보를 동시에 학습하도록 구성.

3. 시점별 스키마 차이를 자동 흡수하도록 변경했습니다.

- 누락 컬럼은 자동 생성하고 결측 플래그를 함께 부여.
- 중간/기말을 단일 파이프라인으로 처리할 수 있도록 스키마를 고정.

4. 추론 feature 정렬을 모델 기준으로 강제했습니다.

- `model.feature_names_in_`를 우선 적용.
- 파이프라인 입력 시 컬럼 순서를 재정렬해 차원 불일치 방지.

5. 사유 분석 로직을 원본 결측 맥락 기반으로 수정했습니다.

- 결측 보정값이 아닌 `missing_map`을 기준으로 설명 생성.
- "점수가 낮음"과 "점수가 없음"을 다른 사유로 분리 표현.

6. 참여도 지표 산식을 상대 기준으로 조정했습니다.

- 고정 임계값 대신 하위 백분위 기반 지표를 활용.
- 학급/학교 분포 차이를 반영해 경보 과다·과소를 완화.

7. 스모크 테스트를 도입했습니다.

- 결측 대체 정상 동작 검증.
- 필수 feature/플래그 생성 검증.
- 예측 경로 기본 동작 검증.
- 전처리 변경 시 최소 회귀를 빠르게 탐지.

---

## 결과

1. 결측/스키마 차이로 인한 학습 및 추론 실패 빈도가 크게 감소했습니다.
2. 모델 해석 관점에서 결측과 실제 저성취를 구분할 수 있게 되어 설명 품질이 개선되었습니다.
3. feature 정합성 보장이 강화되어 배포 이후 입력 오류 리스크가 줄었습니다.
4. 참여도 지표가 상대 맥락을 반영하면서 현장 데이터에서의 경보 품질이 안정화되었습니다.
5. 스모크 테스트 도입으로 전처리 변경 시 회귀 탐지 속도가 향상되었습니다.
6. 결과적으로 파이프라인은 "정확도 중심"에서 "운영 가능성 + 해석 가능성"까지 포함한 안정적 구조로 개선되었습니다.

---

## 관련 파일

- `src/preprocessing.py`
- `src/report_logic.py`
- `src/config.py`
- `scripts/generate_prediction_report.py`
- `scripts/smoke_test_preprocessing.py`
- `scripts/train_model.py`
- `api/main.py`
- `docs/issues_technical_issues_and_resolutions.md`
