# Filter Popover 스크롤/위치 이슈 정리

---

## 전체 요약

대시보드 테이블의 컬럼 헤더에서 필터 팝오버(`FilterPopover`)를 열 때, 스크롤 상태와 헤더 전환 상태에 따라 팝오버가 앵커를 안정적으로 따라가지 못하는 문제가 반복되었습니다.  
특히 고정 헤더(fixed/overlay) 전환과 가로·세로 스크롤이 겹칠 때 좌표 계산 오차가 누적되면서, 팝오버가 헤더에서 떨어지거나 화면 밖으로 벗어나는 현상이 발생했습니다.

이 이슈는 단순 CSS 보정이 아니라 "앵커 재탐색 + 이벤트 기반 위치 재계산 + 뷰포트 경계 보정"을 함께 적용해야 해결되는 유형이었습니다. 최종적으로 훅 수준에서 위치 계산 책임을 재정의하고, DOM 전환 시점까지 고려한 동기화 로직을 적용해 위치 안정성을 확보했습니다.

---

## 문제 정의

1. 스크롤 중 팝오버가 앵커 헤더를 정확히 추적하지 못했습니다.
2. 페이지 상단 복귀 또는 헤더 모드 전환 시 팝오버의 Y축 위치가 튀는 현상이 있었습니다.
3. 우측 끝 컬럼에서 팝오버가 뷰포트 밖으로 밀려나 일부 UI가 보이지 않았습니다.
4. 세로 스크롤바가 표시되는 환경에서 팝오버가 스크롤바 영역과 겹쳐 조작성이 떨어졌습니다.
5. 특정 상황에서는 기존 앵커 DOM 참조가 끊겨 팝오버가 잘못된 위치에 고정되는 케이스가 재현되었습니다.

---

## 원인 파악

1. 초기 구현은 클릭 시점의 `anchorRect`를 기준으로 단발 계산을 수행해 동적 레이아웃 변화를 반영하지 못했습니다.
2. `window` 스크롤 이벤트만 감지하고 실제 스크롤 컨테이너 변화와 헤더 전환 이벤트를 충분히 수집하지 못했습니다.
3. 기본 헤더와 고정 헤더 전환 시 DOM 노드가 교체되는데, 기존 참조를 계속 사용해 좌표 기준이 무효화되었습니다.
4. 뷰포트 경계 계산 시 스크롤바 폭 보정이 빠져 우측 경계 충돌이 발생했습니다.
5. 위치 업데이트를 렌더 사이클에만 의존해 스크롤 중 프레임 단위 동기화가 불안정했습니다.

---

## 해결 방안

1. `useTableFilterPopover`에서 팝오버 오픈 상태의 위치 재계산 책임을 명시적으로 강화했습니다.

- `window` 스크롤/리사이즈 이벤트 수집.
- 테이블 관련 스크롤 컨테이너 이벤트 수집.
- 헤더 전환 완료(`transitionend`) 시점 재계산.

2. 앵커 참조 전략을 변경했습니다.

- 컬럼 키(`data-col-key`)를 기준으로 현재 활성 헤더 DOM을 재탐색.
- 기본 헤더와 오버레이 헤더 중 현재 유효한 앵커를 우선순위 기반으로 선택.
- DOM 교체 이후에도 참조를 즉시 갱신하도록 보완.

3. 위치 업데이트 타이밍을 `requestAnimationFrame` 중심으로 변경했습니다.

- 스크롤 이벤트 폭주 시 불필요한 계산을 줄이고 프레임 단위로 정렬.
- 헤더 전환 직후 짧은 지연 재계산을 추가해 애니메이션 종료 시점 오차를 흡수.

4. 뷰포트 경계 보정 로직을 강화했습니다.

- 우측 경계 클램프 적용.
- 스크롤바 폭(`window.innerWidth - document.documentElement.clientWidth`)을 계산에 반영.
- 팝오버 고정 너비와 좌우 패딩 값을 함께 고려해 안전 영역 내에 배치.

5. 검증 시나리오를 표준화했습니다.

- 세로 스크롤 중 팝오버 추적 확인.
- 상단 복귀 후 재오픈 위치 확인.
- 우측 끝 컬럼 클릭 시 경계 이탈 여부 확인.
- 스크롤바 노출 환경에서 겹침 여부 확인.

---

## 결과

1. 팝오버가 스크롤 및 헤더 전환 상황에서도 앵커를 안정적으로 추적하도록 개선되었습니다.
2. 우측 경계 이탈과 스크롤바 겹침 이슈가 해소되어 필터 접근성이 높아졌습니다.
3. 헤더 DOM 전환이 발생해도 앵커 재탐색이 동작해 위치 오류 재현 빈도가 크게 줄었습니다.
4. `requestAnimationFrame` 기반 업데이트로 스크롤 중 체감 끊김이 감소했습니다.
5. 빌드 및 수동 회귀 점검 기준에서 기존 재현 케이스가 해소된 것을 확인했습니다.

---

## 관련 파일

- `client/src/hooks/useTableFilterPopover.ts`
- `client/src/components/dashboard/FilterPopover.tsx`
- `client/src/components/dashboard/DashboardTable.tsx`
- `client/src/pages/DashboardPage.tsx`
- `client/src/styles/dashboardHeader.scss`
- `docs/issues_filter_popover_scroll_and_positioning.md`
